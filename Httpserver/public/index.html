<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index</title>
    <link rel="stylesheet" href="../css/styles.css" type="text/css">
    <style>
        table {
           width: 100%;
           height: 100%;
           border: 1px dashed black;
           border-collapse: collapse;
        }

        td, th {  
           border: 1px dashed black;
           text-align: center;     
           background-color: bisque;
        }
        #mqttclienthtml{
            width: 100%; 
            height: 100%; 
        }
    </style>
</head>
<!-- <script src="../script/axios.min.js" type="text/javascript"></script> -->
<body>
   <div id="root">

        <div id="sidebar">
          <h2 id="sideMenu">Menu</h2>
          <ul>
            <li ><a href="/Devices" onclick="GetDevices()">Devices</a></li>
            <li ><a href="/Topics" onclick="GetTopics()">Topics</a></li>
            <li ><a href="Virtual Device" onclick="MQTTclientOnWeb()">Virtual Device</a></li>
          </ul>
        </div>
        
        <div id="content">
          <h2 id="DataDisplay">Data Display</h2>
          <h4>Online Client:</h4>&nbsp;<span id="OnlineClient"></span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
          <h4>Max Client:</h4>&nbsp;<span id="MaxClient"></span>
          <div id="dataArea">
          </div>
        </div>    
   </div>
</body>
<script>
    //Get Devices from server
     async function GetDevices(){
        event.preventDefault();
        InitDiv();
        let url ='http://localhost:3000/clientdata';
        let clientdata = await FetchData(url);
        if(clientdata !=null){ 
           TableCreate(clientdata);
        }
        GetclientNumber();
     }  

    function MQTTclientOnWeb(){
        event.preventDefault();
        InitDiv();    
        const root = document.getElementById('dataArea');
        root.innerHTML = '<iframe src="../public/mqtt.html" id="mqttclienthtml" style="width: 100%; height: 100%; border: none;"></iframe>';
     }

    async function GetTopics(){
        event.preventDefault();
        InitDiv();
        let url ='http://localhost:3000/topics';
        let clientdata = await FetchData(url);
        if(clientdata !=null){
          TableCreate(clientdata);
        }
     }
    // Get Client Number
   async function GetclientNumber(){
       let urlOnline = 'http://localhost:3000/OnlineClient';
       let onlinenum = await FetchData(urlOnline);
       document.getElementById('OnlineClient').innerHTML = onlinenum;
       
       let urlMax = 'http://localhost:3000/MaxClient';
       let maxnum = await FetchData(urlMax);
       document.getElementById('MaxClient').innerHTML = maxnum;
     }
    
window.addEventListener('load',GetclientNumber());

function TableCreate(data){

        const root = document.getElementById('dataArea');
        //create table
        const table = document.createElement('table');
        //create table head
        const thead = document.createElement('thead');
        //create table header
        const headerRow = document.createElement('tr');

        //create table header
        const keys = Object.keys(data[0]);
        keys.forEach(key => {
            const th = document.createElement('th');
            th.textContent = key;
            headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);
        //create table body
        const tbody = document.createElement('tbody');
        data.forEach(row => {
            const tr = document.createElement('tr');
            keys.forEach(key => {
                const td = document.createElement('td');
                td.textContent = row[key];
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        root.appendChild(table);
}

function InitDiv(){
   const root = document.getElementById('dataArea');
   root.innerHTML = "";
}

async function FetchData(url) {
    try {
        const response = await fetch(url, { method: 'GET' });
        if (!response.ok) {
            //throw Error('Did not receive expected data');
            return null;
        }
        const responseBody = await response.json();
        if (responseBody.length === 0) {
            return null;  
        } else {
            return responseBody;  
        }
    } catch (error) {
        console.error('Error fetching client data:', error);
        throw error;  
    }
}



</script>
</html>